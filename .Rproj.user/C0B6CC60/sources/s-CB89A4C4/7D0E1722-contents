library(tidyverse)
library(scales)
library(openxlsx)

as_of_date <- Sys.Date()
report_name <- "PA73405 - Attrition by Job 2009"

deskhistory_table <- read_csv("https://raw.githubusercontent.com/harryahlas/sample-hr-database/master/data/deskhistory_table.csv")
deskjob_table <- read_csv("https://raw.githubusercontent.com/harryahlas/sample-hr-database/master/data/deskjob_table.csv")

hierarchy_spread <- read_csv("https://raw.githubusercontent.com/harryahlas/sample-hr-database/master/data/hierarchy_spread.csv")

glimpse(hierarchy_spread, width = 70)

hierarchy_spread %>% count(lvl01_org) %>% arrange(desc(n))


hierarchy_spread_lvl02 <- hierarchy_spread %>% 
  select(lvl01_desk_id, lvl01_org, desk_id = lvl02_desk_id) %>% 
  distinct()

hierarchy_spread_lvl03 <- hierarchy_spread %>% 
  select(lvl01_desk_id, lvl01_org, desk_id = lvl03_desk_id) %>% 
  distinct()

hierarchy_spread_all <- hierarchy_spread %>% 
  bind_rows(hierarchy_spread_lvl02, hierarchy_spread_lvl03)

glimpse(hierarchy_spread_all,width = 70)


deskhistory_table_hierarchy <- deskhistory_table %>% 
  left_join(hierarchy_spread_all %>% select(lvl01_desk_id,
                                            lvl01_org,
                                            desk_id) %>% distinct(), by = "desk_id")

glimpse(deskhistory_table_hierarchy[sample(1:nrow(deskhistory_table_hierarchy)),], width = 70)


LOB_list <- hierarchy_spread_all %>% 
  select(lvl01_org, lvl01_desk_id) %>% 
  distinct()
LOB_list


for (i in (1:length(LOB_list$lvl01_org))) {
  
  org_name <- LOB_list$lvl01_org[i]
  hcto_summary <- deskhistory_table_hierarchy %>% 
    filter(lvl01_org == LOB_list$lvl01_org[i]) %>% # Added for this example
    left_join(deskjob_table) %>% 
    filter(desk_id_start_date <= as.Date("2009-12-31"),
           desk_id_end_date >= as.Date("2009-01-01")) %>% 
    arrange(desc(desk_id_end_date)) %>% 
    group_by(employee_num) %>% 
    filter(row_number() == 1) %>% 
    ungroup() %>% 
    mutate(year = "2009",
           termination_flag = if_else(termination_flag == 1, "Terminated", "DidNotTerminate")) %>% 
    count(year, job_name, termination_flag) %>% 
    spread(termination_flag, n, fill = 0) %>% 
    mutate(Headcount =  Terminated + DidNotTerminate,
           TerminationRate = percent(Terminated / Headcount)) %>% 
    arrange(desc(Terminated / Headcount))
  
  disclaimer_info <-   data.frame(Information = 
                                    c("Source: https://github.com/harryahlas/sample-hr-database/tree/master/data",
                                      paste("Data as of", as_of_date, "."),
                                      paste("Data includes all employees in", org_name ,"who were active at any point from Jan 1, 2009 through December 31, 2009."), # Added for this example
                                      "If the employee had multiple jobs during 2009, only the most recent job is counted.",
                                      "Data is confidential and should be shared on a need to know basis only.",
                                      "Do not distribute externally."))
  wb <- createWorkbook()
  addWorksheet(wb, report_name)
  addWorksheet(wb, "Data Disclaimer")
  writeDataTable(wb, 1, hcto_summary)
  writeDataTable(wb, 2, disclaimer_info)
  addStyle(wb, 2, style = createStyle(wrapText = TRUE), rows = 1:7, cols = 1)
  setColWidths(wb, 2, 1, widths = 50)
  saveWorkbook(wb, paste0("output/", report_name, " - ", org_name, " - ", as_of_date, ".xlsx"), TRUE) # New
}



